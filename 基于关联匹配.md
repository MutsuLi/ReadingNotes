## 3.1 互相关(Correlation-Based)匹配

互相关匹配(Correlation-Based)是基于灰度值。 该方法使用归一化互相关来评估模型与搜索图像之间的对应关系。 这一算法执行速度快并且可以补偿照度的相加和相乘变化。与基于形状的匹配相比，形状略有变化，纹理很多的对象或模糊的对象也可以找到图像（例如，由于散焦，轮廓在模糊的图像中消失), 而这些情况是形状匹配做不到的。

### 3.1.1 代码示例

以下程序演示了针对纹理和散焦的基于相关性匹配的鲁棒性。

* 步骤1：在参考图片中选择对象

    > - 首先，在训练图像内使用gen_rectangle1创建一个包含对象的区域。 使用area_center查询该区域的中心。 在以后的步骤中将需要将匹配结果与原始区域重叠。 然后，将图像缩小到关注区域。

    ![avatar](./picture/corrlation_based_1.png)

    图3.1 ：（左）参考图像，带有用于创建模型的ROI； （右）匹配模型的散焦实例。

    ``` 
    read_image (Image, 'smd/smd_on_chip_05')
    gen_rectangle1 (Rectangle, 175, 156, 440, 460)
    area_center (Rectangle, Area, RowRef, ColumnRef)
    reduce_domain (Image, Rectangle, ImageReduced)
    ```

* 步骤2：建立模型

  > - 缩小的图像用于使用create_ncc_model创建NCC模型。 结果，操作员返回新创建的模型（ModelID）的句柄，然后该句柄可用于指定模型，例如，在对操作员find_ncc_model或find_ncc_models的调用中。
  

    ``` 
    create_ncc_model (ImageReduced, 'auto', 0, 0, 'auto', 'use_polarity', ModelID)
    ```

* 步骤3：再次找到对象

  > - 现在，循环搜索搜索图像，对于每个搜索图像，使用第29页的第2.4.2.1节中所述的仿射变换来搜索NCC模型并将其覆盖在模型的区域中。请注意，在 聚焦图像，然后将搜索应用于具有不同散焦的图像。 尽管如此，所有对象实例都已找到。 图3.1显示了参考图像和散焦但找到的模型实例之一。

    

    ``` 

    for J := 1 to 11 by 1
    read_image (Image, 'smd/smd_on_chip_' + J$'02')
    find_ncc_model (Image, ModelID, 0, 0, 0.5, 1, 0.5, 'true', 0, Row, Column, Angle, Score)
    dev_display (Image)
    dev_display_ncc_matching_results (ModelID, 'green', Row, Column, Angle, 0)endfor
     ```

### 3.1.2选择模型ROI

* 作为基于相关性匹配的第一步，必须按照第17页的2.1.1节中所述选择指定模板图像的感兴趣区域。该区域可以具有任意形状，即，也可以包含孔或由未连接的几个部分组成。

<!-- 　&nbsp; 因此，可以创建仅包含对象“鲁棒”部分的ROI。在大多数情况下，必须选择ROI，以便它还包含感兴趣对象之外的一些像素，因为需要对象的直接周围环境（邻域）才能获得模型。但是，如果对象本身包含足以独立于其轮廓识别的结构，则也可以选择小于对象的对象。然后，还可以在不同背景之前找到对象。 -->

* 请注意，可以使用子采样来加快以后的搜索速度（请参阅第3.1.3.1节）。为此，ROI不应太“薄”，因为否则它会在较高的金字塔层次上消失！根据经验，如果ROI的宽度为$2^{NumLevels-1}$像素，则您会处于安全状态。也就是说，8像素的宽度允许使用4个金字塔等级。

<!-- 在选择了合适的ROI之后，将缩小后的图像用作模板图像以创建模型。 -->

### 3.1.3创建合适的NCC模型

可以使用运算符create_ncc_model创建NCC模型。

``` 

create_ncc_model(Template : : NumLevels, AngleStart, AngleExtent, AngleStep,Metric : ModelID)
```

* 通过调整参数NumLevels（第3.1.3.1节）来使用子采样来加快搜索速度.
* 通过调整参数AngleExtent，AngleStart和AngleStep（第3.1.3.2节）和指定在以后的搜索中将哪些像素与模型进行比较，即通过调整参数Metric（第3.1.3.3节）来指定对象的极性.
* 对于参数NumLevels和AngleStep，可以让HALCON自动建议值。可以通过将create_ncc_model中的参数设置为值“auto”来完成；然后，如果您需要知道这些值，可以使用get_ncc_model_params查询它们。或者，在创建模型之前应用确定的_ncc_model_params。然后，您可以估算自动确定的值作为建议，因此您仍然可以为实际创建模型修改它们。请注意，两种方法仅返回大致相同的值，并且create_ncc_model返回的值更精确。

* 通过调整参数Metric可指定是否遵守极性，即对比度的“方向”。如果选择“use_polarity”值，则会观察到极性，即，搜索图像中的点必须显示与模型中相应点相同的对比度方向。例如，如果模型是深色背景上的明亮对象，则仅当该对象也比背景明亮时，才能在搜索图像中找到该对象。您可以选择值“ ignore_global_polarity”来选择全局忽略极性。<!-- 在此模式下，如果对象的对比度方向相反，例如，如果您的对象在浅色背景上既可以显示为深色，反之亦然，则也可以识别该对象。 -->但是，这种灵活性是以稍微降低识别速度和降低鲁棒性为代价的。

<!-- 请注意，在创建模型之后，仍可以修改模型。在第3.1.3.4节中显示了检查和修改已创建模型的可能性，并显示了已创建模型的检查和修改。 -->

<!-- #### 3.1.3.1 使用子采样加快搜索速度（NumLevels）

为了加快匹配过程，可以使用子采样（另请参阅第25页的2.3.2节）。
在那里，创建了一个图像金字塔，包括原始的全尺寸图像和一组下采样图像。然后在不同的金字塔等级上创建并搜索模型。您可以通过参数NumLevels指定使用多少个金字塔等级。我们建议通过指定值“ auto”让HALCON自己选择合适的值。然后，您可以通过运算符get_ncc_model_params查询使用的值。 -->

<!-- #### 3.1.3.2 允许方向范围（AngleExtent，AngleStart，AngleStep）

如果搜索图像中对象的旋转角度可能有所不同，则可以在参数AngleExtent中指定允许范围，并在参数AngleStart中指定该范围的起始角度（单位：弧度）。我们建议尽可能限制旋转范围，以加快搜索过程。在匹配过程中，以参数AngleStep指定的步长在允许范围内的不同角度搜索模型。如果您选择“自动”值，HALCON会自动选择最佳步长，以通过确定图像中仍可分辨的最小旋转量来获得最高的精度。在部分
第58页的3.2.3.3提供了用于基于形状的匹配的所有三个参数的值选择技巧。这些技巧对于基于相关的匹配也有效。 -->

<!-- #### 3.1.3.3 指定如何将灰度值与模型（指标）进行比较

参数Metric可让您指定是否必须遵守极性，即对比度的“方向”。如果您选择“ use_polarity”值，则会观察到极性，即，搜索图像中的点必须显示与模型中相应点相同的对比度方向。例如，如果模型是深色背景上的明亮对象，则仅当该对象也比背景明亮时，才能在搜索图像中找到该对象。您可以选择值“ ignore_global_polarity”来选择全局忽略极性。在此模式下，如果对象的对比度方向相反，例如，如果您的对象在浅色背景上既可以显示为深色，反之亦然，则也可以识别该对象。但是，这种灵活性是以稍微降低识别速度和降低鲁棒性为代价的。 -->

<!-- #### 3.1.3.4检查和修改NCC模型

要检查模型的当前参数值，请使用get_ncc_model_params查询它们。如果在模型创建期间使用了自动参数选择，则可能有必要
或者，如果模型是在另一个程序中创建的，则使用write_ncc_model保存到文件，然后使用read_ncc_model从当前程序中的该文件读取。另外，您可以使用get_ncc_model_origin查询模型原点的坐标。在创建模型之后以及在搜索图像中搜索对象之前，可以进一步修改模型。特别是，您可以应用set_ncc_model_param更改单个参数，并应用set_ncc_model_origin更改模型的原点。后者是
不建议这样做，因为匹配结果的准确性可能会降低，有关基于形状的匹配的详细信息，请参见第68页的3.2.4.8节。 -->

### 3.1.4 优化搜索过程

实际匹配是由运算符find_ncc_model或find_ncc_models执行的。

``` 

find_ncc_model(Image : : ModelID, AngleStart, AngleExtent, MinScore, NumMatches, MaxOverlap, SubPixel, NumLevels : Row, Column, Angle, Score)
```

<!-- 在下文中，我们展示了如何为这些运算符选择合适的参数以适应和优化匹配任务。特别是，我们展示了如何 -->

<!-- * 将搜索空间限制在感兴趣的区域（第3.1.4.1节）， -->

* 通过参数AngleStart和AngleExtent来限制方向范围，从而限制搜索空间；
* 将搜索空间限制为与对象模型之间有一定程度的偏差，即通过参数MinScore（第3.1.4.3节）指定对象的相似性，
* 通过调整参数NumMatches选择返回的最大匹配数
* 通过调整参数MaxOverlap指定实例可以重叠的程度

<!-- * 只需一个操作员呼叫即可搜索多个模型（第3.1.4.5节）， -->

* 通过调整参数SubPixel（第3.1.4.6节）来指定结果所需的精度，并且
* 限制搜索过程的金字塔级别（NumLevels）的数量, 通过将值0用于NumLevels，使用在创建模型时指定的值。

<!-- ### 3.1.4.1将搜索限制在感兴趣的区域

限制搜索空间并因此加快匹配速度的明显方法是将运算符find_ncc_model应用于整个图像，而不是整个ROI。有关基于形状的匹配的相应过程，请参见第63页的第3.2.4.1节。对于基于相关性的匹配，只需将find_shape_model替换为find_ncc_model。

### 3.1.4.2限制方向范围（AngleStart，AngleExtent）

创建模型时，您已经指定了允许的方向范围（请参阅第49页的3.1.3.2节）。调用运算符find_ncc_model时，您可以进一步限制范围
参数AngleStart和AngleExtent。如果您可以通过其他信息（例如，可以通过适当的图像处理操作获得这些信息）来限制这些范围，则此功能很有用。创建模型时使用更大范围的另一个原因可能是您想将模型重用于其他匹配任务。

### 3.1.4.3指定对象的相似性（MinScore）

参数MinScore指定必须将潜在匹配作为匹配返回的最低分数。分数是用于模型和搜索图像之间的匹配质量（即，对应性或“相似性”）的值。对于基于相关的匹配，可使用图案和图像之间的归一化互相关来获得分数（有关公式，请参见《参考手册》中对find_ncc_model的描述）。为了加快搜索速度，应将MinScore的值选择得尽可能大，但当然，仍应尽可能小以使搜索成功。

### 3.1.4.4搜索对象的多个实例（NumMatches，MaxOverlap）

要在搜索图像中找到一个模型的多个实例，可通过参数NumMatches选择返回的最大匹配数。此外，参数MaxOverlap指定实例可以重叠的程度。在第66页的3.2.4.6节中，对基于形状的匹配的相应参数进行了更详细的说明。那里给出了参数选择的提示，这些提示对于基于相关的匹配也有效。请注意，如果搜索并找到对象的多个实例，则参数Row，Column，Angle和Score包含元组。怎么样
 在第72页的3.2.5.1节中示例性地显示了访问这些结果的方式。

 #### 3.1.4.5同时搜索多个模型（ModelID）

如果要在单个图像中搜索多个模型的实例，则当然可以多次调用运算符find_ncc_model。但是更快的替代方法是使用运算符find_ncc_models。该操作员期望相似的参数，但有以下差异：

•使用参数ModelIDs，您可以指定一个模型ID的元组，而不是一个。与搜索多个实例时一样（请参阅第3.1.4.4节），匹配结果参数Row等将返回值的元组。
•输出参数Model显示每个找到的实例属于哪个模型。请注意，该参数不会返回模型ID本身，而是返回模型ID在元组ModelID中的索引（从0开始）。
•搜索总是在单个图像中执行。但是，您可以通过传递图像数组将搜索范围分别限制为每个模型的特定区域。
•您可以通过为AngleStart等指定单个值来对每个模型使用相同的搜索参数，或者传递包含每个模型的单个值的元组。
•您还可以搜索多个模型的多个实例。如果搜索与对象类型（型号ID）无关的一定数量的对象，请在参数NumMatches中指定此（单个）值。通过传递值的元组，可以为每个模型分别指定要查找的实例数。元组[3, 0]，例如，指定返回第一个模型的最佳三个实例和第二个模型的所有实例。
同样，如果为MaxOverlap指定单个值，则运算符将检查找到的实例是否被其他任何实例所覆盖，而与它们的类型无关。通过指定值的元组，将仅对照相同类型的所有其他实例检查每个实例。

#### 3.1.4.6指定所需的精度（SubPixel）

参数SubPixel指定是以像素精度（SubPixel设置为"false"）还是以子像素精度（SubPixel设置为"true"）返回找到的模型实例的位置和方向。由于子像素精度几乎与像素精度一样快，因此我们建议将SubPixel设置为"true"。

#### 3.1.4.7限制金字塔等级的数量（NumLevels）

创建模型时已经指定的参数NumLevels允许您在搜索过程中使用不同的值（在大多数情况下，限制更大）。通过将值0用于NumLevels，使用在创建模型时指定的值。
（可选）NumLevels可以包含第二个值，以便您不仅可以指定用于搜索的最高金字塔等级，还可以指定最低金字塔等级。如果搜索是在高于第一金字塔级别的金字塔级别上完成的，金字塔级别对应于原始的完整级别，而金字塔的原始级别对应于原始的全尺寸图像，搜索变得更快。另一方面，搜索也因此不那么健壮，也不那么准确。

#### 3.1.4.8通过set_ncc_model_param设置NCC模型参数“超时”

如果您的应用程序要求必须在特定时间内执行搜索，则可以使用运算符set_ncc_model_param设置参数“ timeout”以指定可以保证搜索终止的最长时间，即，您可以搜索可中断。但是请注意，对于中断的搜索，不会返回任何结果。此外，设置超时机制时，搜索的运行时间可能会增加多达10％。 -->
